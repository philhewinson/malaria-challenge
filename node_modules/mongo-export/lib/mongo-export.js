/* ================================================================
 * mongo-export by xdf(xudafeng[at]126.com)
 *
 * first created at : Wed Nov 18 2015 19:37:59 GMT+0800 (CST)
 *
 * ================================================================
 * Copyright  xdf
 *
 * Licensed under the MIT License
 * You may not use this file except in compliance with the License.
 *
 * ================================================================ */

'use strict';

var fs = require('fs');
var path = require('path');
var spawnp = require('./spawn-promise');

var cwd = process.cwd();

function formatDate(time) {
  var res = time.getFullYear();
  res += '-' + (time.getMonth() + 1);
  res += '-' + time.getDate();
  res += '-' + time.getHours();
  res += '-' + time.getMinutes();
  res += '-' + time.getSeconds();
  return res;
}

module.exports = function(context) {
  if (context.method === 'GET') {
    context.body = '<form action="';

    if (context.csrf) {
      context.body += '?_csrf=' + context.csrf;
    }
    context.body += '" method="post">';
    context.body += '<input type="submit" value="Export" />';
    context.body += '</form>';
    return Promise.resolve(true);
  } else {
    return spawnp('mongodump', {}, {
      cwd: cwd
    }).then(function() {
      return spawnp('tar', ['-zcvf', 'dump.zip', './dump']).then(function() {
        var file = path.join(cwd, 'dump.zip');
        context.type = 'application/force-download';
        var date = formatDate(new Date(fs.statSync(file).mtime));
        context.set('Content-Disposition', 'attachment; filename=dump-' + date + '.zip');
        return new Promise(function(resolve, reject) {
          fs.readFile(file, function(err, stdout) {
            if (err) {
              return reject(err);
            }
            context.body = stdout;
            resolve();
          });
        });
      });
    });
  }
};
